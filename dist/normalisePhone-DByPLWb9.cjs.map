{"version":3,"file":"normalisePhone-DByPLWb9.cjs","names":["reasons: string[]","PhoneChangeCodes","changeCodes: PhoneChangeCode[]","metadata: PhoneNormResult['metadata']","isEmpty","SYMBOL_TRANSLITERATION_MAP","extension: string | null","resolvePhoneNumber","DEFAULT_BLOCKLIST","isBlockedNumber","format: PhoneFormat","formatted: string | null"],"sources":["../src/utils/phone/normalisePhone.ts"],"sourcesContent":["import type { PhoneChangeCode } from './constants'\nimport {\n  DEFAULT_BLOCKLIST,\n  PhoneChangeCodes,\n  SYMBOL_TRANSLITERATION_MAP,\n} from './constants'\nimport type {\n  PhoneFixResult,\n  PhoneFormat,\n  PhoneNormOptions,\n  PhoneNormResult,\n} from './types'\nimport { isBlockedNumber, isEmpty, resolvePhoneNumber } from './validatePhone'\n\n/**\n * Replaces unicode digits/symbols using the provided transliteration map.\n *\n * @param value - Raw phone number string to process.\n * @param map - Mapping of unicode characters to ASCII replacements.\n * @returns Object containing the transliterated string and a change flag.\n */\nfunction applySymbolMap(\n  value: string,\n  map: Record<string, string>\n): PhoneFixResult {\n  let out = value\n\n  for (const [from, to] of Object.entries(map)) {\n    const escaped = from.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')\n    out = out.replace(new RegExp(escaped, 'g'), to)\n  }\n\n  return {\n    out,\n    changed: out !== value,\n  }\n}\n\n/**\n * Removes obvious prefixes/extra whitespace prior to parsing.\n *\n * @param value - Raw phone number string to tidy.\n * @returns Object containing the tidied string and a change flag.\n */\nfunction tidyDialString(value: string): PhoneFixResult {\n  let out = value.replace(/^(tel|phone|call)[:\\s]+/i, '')\n  out = out.replace(/\\s+/g, ' ').trim()\n\n  return {\n    out,\n    changed: out !== value,\n  }\n}\n\n/**\n * Pulls trailing extension notes off the raw number before validation.\n *\n * @param value - Raw phone number string to process.\n * @returns Object containing the string without extension, the extracted extension, and a change flag.\n */\nfunction stripExtension(value: string): {\n  out: string\n  extension: string | null\n  changed: boolean\n} {\n  const match = value.match(/(?:ext\\.?|extension|x|#)\\s*(\\d{1,6})$/i)\n\n  if (!match) {\n    return {\n      out: value,\n      extension: null,\n      changed: false,\n    }\n  }\n\n  const next = value.slice(0, match.index).trim()\n\n  return {\n    out: next,\n    extension: match[1] || null,\n    changed: true,\n  }\n}\n\n/**\n * Converts internal change codes into human-readable reasons.\n *\n * @param codes - List of phone change codes to map.\n * @returns Array of human-readable change reasons.\n */\nfunction mapChangeCodesToReason(codes: PhoneChangeCode[]): string[] {\n  const reasons: string[] = []\n\n  for (const code of codes) {\n    switch (code) {\n      case PhoneChangeCodes.NORMALISED_SYMBOLS:\n        reasons.push('Converted unicode digits and separators.')\n        break\n      case PhoneChangeCodes.STRIPPED_EXTENSION:\n        reasons.push('Removed phone extension text.')\n        break\n      case PhoneChangeCodes.APPLIED_DEFAULT_COUNTRY:\n        reasons.push('Applied default or fallback country code.')\n        break\n      case PhoneChangeCodes.FORMATTED_OUTPUT:\n        reasons.push('Formatted using the requested output style.')\n        break\n      case PhoneChangeCodes.BLOCKED_BY_LIST:\n        reasons.push('Phone number is blocklisted.')\n        break\n      case PhoneChangeCodes.COUNTRY_NOT_ALLOWED:\n        reasons.push('Phone number country is not permitted.')\n        break\n      case PhoneChangeCodes.INVALID_SHAPE:\n        reasons.push('Phone number could not be parsed.')\n        break\n      default:\n        console.warn(`Unknown phone change code: ${code as string}`)\n        break\n    }\n  }\n\n  return reasons\n}\n\n/**\n * Ensures `changes` always mirrors `changeCodes` when returning results.\n *\n * @param params - Partial phone normalization result without `changes`.\n * @returns Complete PhoneNormResult with human-readable `changes`.\n */\nfunction buildResult(\n  params: Omit<PhoneNormResult, 'changes'>\n): PhoneNormResult {\n  return {\n    ...params,\n    changes: mapChangeCodesToReason(params.changeCodes),\n  }\n}\n\n/**\n * Full phone number normaliser that cleans, parses, and validates input.\n *\n * @param raw - Raw phone number string to normalise.\n * @param options - Normalisation configuration options.\n * @returns Complete phone normalization result.\n */\nexport function normalisePhone(\n  raw: string,\n  options: PhoneNormOptions = {}\n): PhoneNormResult {\n  const enabled = options.enabled ?? true\n  const changeCodes: PhoneChangeCode[] = []\n  const metadata: PhoneNormResult['metadata'] = {\n    e164: null,\n    international: null,\n    national: null,\n    type: null,\n    extension: null,\n  }\n\n  if (!enabled) {\n    return buildResult({\n      phone: raw ?? null,\n      valid: true,\n      country: null,\n      changeCodes,\n      metadata,\n    })\n  }\n\n  let working = String(raw ?? '').trim()\n\n  if (isEmpty(working)) {\n    changeCodes.push(PhoneChangeCodes.INVALID_SHAPE)\n\n    return buildResult({\n      phone: null,\n      valid: false,\n      country: null,\n      changeCodes,\n      metadata,\n    })\n  }\n\n  const symbolMap = {\n    ...SYMBOL_TRANSLITERATION_MAP,\n    ...(options.symbolMap || {}),\n  }\n  const ascii = applySymbolMap(working, symbolMap)\n  if (ascii.changed) {\n    working = ascii.out\n    changeCodes.push(PhoneChangeCodes.NORMALISED_SYMBOLS)\n  }\n\n  const tidied = tidyDialString(working)\n  if (tidied.changed) {\n    working = tidied.out\n  }\n\n  let extension: string | null = null\n  if (options.stripExtensions ?? true) {\n    const stripped = stripExtension(working)\n    if (stripped.changed) {\n      working = stripped.out\n      extension = stripped.extension\n      changeCodes.push(PhoneChangeCodes.STRIPPED_EXTENSION)\n    }\n  }\n\n  const resolved = resolvePhoneNumber(working, {\n    defaultCountry: options.defaultCountry,\n    fallbackCountries: options.fallbackCountries,\n  })\n\n  if (!resolved) {\n    changeCodes.push(PhoneChangeCodes.INVALID_SHAPE)\n\n    return buildResult({\n      phone: null,\n      valid: false,\n      country: null,\n      changeCodes,\n      metadata,\n    })\n  }\n\n  const { phoneNumber, usedFallback } = resolved\n  const country = phoneNumber.country ?? null\n\n  if (usedFallback) {\n    changeCodes.push(PhoneChangeCodes.APPLIED_DEFAULT_COUNTRY)\n  }\n\n  if (!phoneNumber.isValid()) {\n    changeCodes.push(PhoneChangeCodes.INVALID_SHAPE)\n\n    return buildResult({\n      phone: null,\n      valid: false,\n      country,\n      changeCodes,\n      metadata,\n    })\n  }\n\n  metadata.e164 = phoneNumber.number ?? null\n  metadata.international = phoneNumber.formatInternational()\n  metadata.national = phoneNumber.formatNational()\n  metadata.extension = extension || phoneNumber.ext || null\n  metadata.type = phoneNumber.getType ? (phoneNumber.getType() ?? null) : null\n\n  const blocklist = options.blocklist || DEFAULT_BLOCKLIST\n  if (isBlockedNumber(metadata.e164, blocklist, country)) {\n    changeCodes.push(PhoneChangeCodes.BLOCKED_BY_LIST)\n\n    return buildResult({\n      phone: metadata.e164,\n      valid: false,\n      country,\n      changeCodes,\n      metadata,\n    })\n  }\n\n  if (\n    options.allowedCountries?.length &&\n    (!country || !options.allowedCountries.includes(country))\n  ) {\n    changeCodes.push(PhoneChangeCodes.COUNTRY_NOT_ALLOWED)\n\n    return buildResult({\n      phone: metadata.e164,\n      valid: false,\n      country,\n      changeCodes,\n      metadata,\n    })\n  }\n\n  const format: PhoneFormat = options.format ?? 'E.164'\n  let formatted: string | null = metadata.e164\n\n  switch (format) {\n    case 'INTERNATIONAL':\n      formatted = phoneNumber.formatInternational()\n      break\n    case 'NATIONAL':\n      formatted = phoneNumber.formatNational()\n      break\n    // case 'RFC3966':\n    //   formatted = phoneNumber.formatRFC3966()\n    //   break\n    default:\n      formatted = metadata.e164\n      break\n  }\n\n  if (format !== 'E.164') {\n    changeCodes.push(PhoneChangeCodes.FORMATTED_OUTPUT)\n  }\n\n  return buildResult({\n    phone: formatted ?? metadata.international ?? metadata.national,\n    valid: true,\n    country,\n    changeCodes,\n    metadata,\n  })\n}\n"],"mappings":"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"}